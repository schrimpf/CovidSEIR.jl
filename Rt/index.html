<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Paul Schrimpf">
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Reproductive number - CovidSEIR.jl</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atelier-forest-light.min.css">
        <link href="../assets/Documenter.css" rel="stylesheet">
        <link href="../assets/extra.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">CovidSEIR.jl</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Package Docs</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">SEIR Model and Results <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../covid/" class="dropdown-item">Model</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Results</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../canada/" class="dropdown-item">Canada</a>
</li>
            
<li>
    <a href="../italy/" class="dropdown-item">Italy</a>
</li>
            
<li>
    <a href="../korea/" class="dropdown-item">South Korea</a>
</li>
            
<li>
    <a href="../china/" class="dropdown-item">China</a>
</li>
            
<li>
    <a href="../us/" class="dropdown-item">United States</a>
</li>
    </ul>
  </li>
                                    
<li>
    <a href="../state/" class="dropdown-item">US States</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Reproductive number</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../license/" class="dropdown-item">License</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../state/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../license/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/schrimpf/CovidSEIR.jl/edit/master/docs/Rt.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#model" class="nav-link">Model</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#data" class="nav-link">Data</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#statistical-model" class="nav-link">Statistical Model</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#systroms-approach" class="nav-link">Systrom’s approach</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#an-alternative-approach" class="nav-link">An alternative approach</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#code_1" class="nav-link">Code</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p><a href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a></p>
<p>This work is licensed under a <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike
4.0 International
License</a></p>
<h1 id="model">Model<a class="headerlink" href="#model" title="Permanent link">&para;</a></h1>
<p>Following <a href="http://systrom.com/blog/the-metric-we-need-to-manage-covid-19/">Kevin
Systrom</a>,
we adapt the approach of (Bettencourt <a href="#ref-bettencourt2008">2008</a>) to
compute real-time rolling estimates of pandemic parameters. (Bettencourt
<a href="#ref-bettencourt2008">2008</a>) begin from a SIR model,</p>
<p>
<script type="math/tex; mode=display">
\begin{align*}
\dot{S} & = -\frac{S}{N} \beta I \\
\dot{I} & = \frac{S}{N} \beta I - \gamma I \\
\dot{R} & = \gamma I
\end{align*}
</script>
</p>
<p>To this we add the possibility that not all cases are known. Cases get
get detected at rate $I$, so cumulative confirmed cases, $C$, evolves as</p>
<p>
<script type="math/tex; mode=display">
\dot{C} = \tau I
</script>
</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Should we add other states to this model? If yes, how? I think
using death and hospitalization numbers in estimation makes sense.</p>
</div>
<p>The number of new confirmed cases from time $t$ to $t+\delta$ is then:</p>
<p>We will allow for the testing rate, $\tau$, and infection rate, $\beta$,
to vary over time.</p>
<p>
<script type="math/tex; mode=display">
k_t \equiv \frac{C(t+\delta) - C(t)}{\delta} = \int_t^{t+\delta} \tau(s) I(s) ds
\approx \tau(t) I(t)
</script>
</p>
<p>As in (Bettencourt <a href="#ref-bettencourt2008">2008</a>),</p>
<p>
<script type="math/tex; mode=display">
\begin{align*}
I(t) = & I(t-\delta) \int_{t-\delta}^{t} e^{\frac{S(s)}{N} \beta(s) -
\gamma} ds \\
\approx & I(t-\delta) e^{\delta \left( \frac{S(t-\delta)}{N}
\beta(t-\delta) - \gamma \right)}
\end{align*}
</script>
</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The reproductive number is:
$R_t \equiv \frac{S(t)}{N}\frac{\beta(t)}{\gamma}$.</p>
</div>
<p>Substituting the expression for $I_t$ into $k_t$, we have</p>
<p>
<script type="math/tex; mode=display">
\begin{align*}
k_t \approx & \tau(t) I(t-\delta) e^{\delta \left(
\frac{S(t-\delta)}{N} \beta(t-\delta) - \gamma\right)} \\
\approx & k_{t-\delta} \frac{\tau(t)}{\tau(t-\delta)}
e^{\delta \left(\frac{S(t-\delta)}{N} \beta(t-\delta) - \gamma \right)}
\end{align*}
</script>
</p>
<h1 id="data">Data<a class="headerlink" href="#data" title="Permanent link">&para;</a></h1>
<p>We use the same data as the <a href="../state/">US state model</a>.</p>
<p>The data combines information on</p>
<ul>
<li>Daily case counts and deaths from JHU CSSE</li>
<li>Daily Hospitalizations, recoveries, and testing from the Covid
    Tracking Project</li>
<li>Covid related policy changes from Raifman et al</li>
<li>Movements from Google Mobility Reports</li>
<li>Hourly workers from Hoembase</li>
</ul>
<h1 id="statistical-model">Statistical Model<a class="headerlink" href="#statistical-model" title="Permanent link">&para;</a></h1>
<p>The above theoretical model gives a deterministic relationship between
$k_t$ and $k_{t-1}$ given the parameters. To bring it to data we must
add stochasticity.</p>
<h2 id="systroms-approach">Systrom’s approach<a class="headerlink" href="#systroms-approach" title="Permanent link">&para;</a></h2>
<p>First we describe what Systrom does. He assumes that
$R_{0} \sim Gamma(4,1)$. Then for $t=1, &hellip;, T$, he computes
$P(R_t|k_{t}, k_{t-1}, &hellip; ,k_0)$ iteratively using Bayes’ rules.
Specifically, he assumes <script type="math/tex; mode=display">
k_t | R_t, k_{t-1}, ... \sim Poisson(k_{t-1} e^{\gamma(R_t - 1)})
</script> and that $R_t$ follows a random walk, so the prior of $R_t | R_{t-1}$
is <script type="math/tex; mode=display">
R_t | R_{t-1} \sim N(R_{t-1}, \sigma^2)
</script>
</p>
<p>so that</p>
<p>
<script type="math/tex; mode=display">
P(R_t|k_{t}, k_{t-1}, ... ,k_0) = \frac{P(k_t | R_t, k_{t-1}) P(R_t |
R_{t-1}) P(R_{t-1} | k_{t-1}, ...)} {P(k_t)}
</script>
</p>
<p>Note that this computes posteriors of $R_t$ given current and past
cases. Future cases are also informative of $R_t$, and you could instead
compute $P(R_t | k_0, k_1, &hellip;, k_T)$.</p>
<p>The notebook makes some mentions of Gaussian processes. There’s likely
some way to recast the random walk assumption as a Gaussian process
prior (the kernel would be $\kappa(t,t&rsquo;) = \min{t,t&rsquo;} \sigma^2$), but
that seems to me like an unusual way to describe it.</p>
<h3 id="code">Code<a class="headerlink" href="#code" title="Permanent link">&para;</a></h3>
<p>Let’s see how Systrom’s method works.</p>
<p>First the load data.</p>
<pre><code class="julia">using DataFrames, Plots, StatsPlots, CovidSEIR
Plots.pyplot()

df = CovidSEIR.statedata()
df = filter(x-&gt;x.fips&lt;60, df)
# focus on 10 states with most cases as of April 1, 2020
sdf = select(df[df[!,:date].==Dates.Date(&quot;2020-04-01&quot;),:], :cases, :state) |&gt;
    x-&gt;sort(x,:cases, rev=true)
states=sdf[1:10,:state]
sdf = select(filter(r-&gt;r[:state] ∈ states, df), :cases, :state, :date)
sdf = sort(sdf, [:state, :date])
sdf[!,:newcases] = by(sdf, :state, newcases = :cases =&gt; x-&gt;(vcat(missing, diff(x))))[!,:newcases]

figs = []
for gdf in groupby(sdf, :state)
  @show unique(gdf.state)
  f = @df gdf plot(:date, :newcases, legend=:none, linewidth=2, title=unique(gdf.state)[1])
  global figs = vcat(figs,f)
end
</code></pre>

<pre><code>unique(gdf.state) = ["California"]
unique(gdf.state) = ["Florida"]
unique(gdf.state) = ["Illinois"]
unique(gdf.state) = ["Louisiana"]
unique(gdf.state) = ["Massachusetts"]
unique(gdf.state) = ["Michigan"]
unique(gdf.state) = ["New Jersey"]
unique(gdf.state) = ["New York"]
unique(gdf.state) = ["Pennsylvania"]
unique(gdf.state) = ["Washington"]
</code></pre>
<pre><code class="julia">display(plot(figs[1:9]..., layout=(3,3)))
</code></pre>

<p><img alt="" src="../figures/Rt_1_1.png" /></p>
<p>From this we can see that new cases are very noisy. This is especially
problematic when cases jump from near 0 to very high values, such as in
Illinois. The median value of and variance of new cases, $k_t$, are both
$k_{t-1} e^{\gamma(R_t - 1)}$. Only huge changes in $R_t$ can
rationalize huge jumps in new cases.</p>
<p>Let’s compute posteriors for each state.</p>
<pre><code class="julia">using Interpolations, Distributions

function rtpost(cases, γ, σ, prior0, casepdf)
  (rgrid, postgrid, ll) = rtpostgrid(cases)(γ, σ, prior0, casepdf)
  w = rgrid[2] - rgrid[1]
  T = length(cases)
  p = [LinearInterpolation(rgrid, postgrid[:,t]) for t in 1:T]
  coverage = 0.9
  cr = zeros(T,2)
  mu = vec(rgrid' * postgrid*w)
  for t in 1:T
    l = findfirst(cumsum(postgrid[:,t].*w).&gt;(1-coverage)/2)
    h = findlast(cumsum(postgrid[:,t].*w).&lt;(1-(1-coverage)/2))
    if !(l === nothing || h === nothing)
      cr[t,:] = [rgrid[l], rgrid[h]]
    end
  end
  return(p, mu, cr)
end

function rtpostgrid(cases)
  # We'll compute the posterior on these values of R_t
  rlo = 0
  rhi = 8
  steps = 500
  rgrid = range(rlo, rhi, length=steps)
  Δgrid = range(0.05, 0.95, length=10)
  w = rgrid[2] - rgrid[1]
  dr = rgrid .- rgrid'
  fn=function(γ, σ, prior0, casepdf)
    prr = pdf.(Normal(0,σ), dr) # P(r_{t+1} | r_t)
    for i in 1:size(prr,1)
      prr[i, : ] ./= sum(prr[i,:].*w)
    end
    postgrid = Matrix{typeof(σ)}(undef,length(rgrid), length(cases)) # P(R_t | k_t, k_{t-1},...)
    like = similar(postgrid, length(cases))
    for t in 1:length(cases)
      if (t==1)
        postgrid[:,t] .= prior0.(rgrid)
      else
        if (cases[t-1]===missing || cases[t]===missing)
          pkr = 1  # P(k_t | R_t)
        else
          λ = max(cases[t-1],1).* exp.(γ .* (rgrid .- 1))
          #r = λ*nbp/(1-nbp)
          #pkr = pdf.(NegativeBinomial.(r,nbp), cases[t])
          pkr = casepdf.(λ, cases[t])
          if (all(pkr.==0))
            @warn &quot;all pkr=0&quot;
            @show t, cases[t], cases[t-1]
            pkr .= 1
          end
        end
        postgrid[:,t] = pkr.*(prr*postgrid[:,t-1])
        like[t] = sum(postgrid[:,t].*w)
        postgrid[:,t] ./= max(like[t], 1e-15)
      end
    end
    ll = try
      sum(log.(like))
    catch
      -710*length(like)
    end
    return((rgrid, postgrid, ll))
  end
  return(fn)
end

for σ in [0.1, 0.25, 1]
  γ =1/7
  nbp = 0.01
  figs = []
  for gdf in groupby(sdf, :state)
    p, m, cr = rtpost(gdf.newcases, γ, σ, x-&gt;pdf(truncated(Gamma(4,1),0,8), x),
                      (λ,x)-&gt;pdf(Poisson(λ),x))
    f = plot(gdf.date, m, ribbon=(m-cr[:,1], cr[:,2] - m), title=unique(gdf.state)[1], legend=:none, ylabel=&quot;Rₜ&quot;)
    f = hline!(f,[1.0])
    figs = vcat(figs, f)
  end
  l = @layout [a{.1h};grid(1,1)]
  display(plot(plot(annotation=(0.5,0.5, &quot;Poisson &amp; σ=$σ&quot;), framestyle = :none),
               plot(figs[1:9]..., layout=(3,3)), layout=l))
end
</code></pre>

<pre><code>(t, cases[t], cases[t - 1]) = (72, 2052, 215)
(t, cases[t], cases[t - 1]) = (77, 9, 1003)
(t, cases[t], cases[t - 1]) = (78, 2807, 9)
(t, cases[t], cases[t - 1]) = (79, 1, 2807)
(t, cases[t], cases[t - 1]) = (80, 2808, 1)
(t, cases[t], cases[t - 1]) = (55, 352, 2)
(t, cases[t], cases[t - 1]) = (54, -39, 74)
(t, cases[t], cases[t - 1]) = (72, 2052, 215)
(t, cases[t], cases[t - 1]) = (77, 9, 1003)
(t, cases[t], cases[t - 1]) = (78, 2807, 9)
(t, cases[t], cases[t - 1]) = (79, 1, 2807)
(t, cases[t], cases[t - 1]) = (80, 2808, 1)
(t, cases[t], cases[t - 1]) = (55, 352, 2)
(t, cases[t], cases[t - 1]) = (54, -39, 74)
(t, cases[t], cases[t - 1]) = (72, 2052, 215)
(t, cases[t], cases[t - 1]) = (77, 9, 1003)
(t, cases[t], cases[t - 1]) = (78, 2807, 9)
(t, cases[t], cases[t - 1]) = (79, 1, 2807)
(t, cases[t], cases[t - 1]) = (80, 2808, 1)
(t, cases[t], cases[t - 1]) = (55, 352, 2)
(t, cases[t], cases[t - 1]) = (54, -39, 74)
</code></pre>
<p><img alt="" src="../figures/Rt_2_1.png" /> <img alt="" src="../figures/Rt_2_2.png" /> <img alt="" src="../figures/Rt_2_3.png" /></p>
<p>In these results, what is happening is that when new cases fluctuate too
much, the likelihood is identically 0, causing the posterior calculation
to break down. Increasing the variance of changes in $R_t$, widens the
posterior confidence intervals, but does not solve the problem of
vanishing likelihoods.</p>
<p>One thing that can “solve” the problem is choosing a distribution of
$k_t | \lambda, k_{t-1}$ with higher variance. The negative binomial
with parameters $\lambda p/(1-p)$ and $p$ has mean $\lambda$ and
variance $\lambda/p$.</p>
<pre><code class="julia">γ =1/7
σ = 0.25

Plots.closeall()
for σ in [0.1, 0.25, 0.5]
  for nbp in [0.5, 0.1, 0.01]
    figs = []
    for gdf in groupby(sdf, :state)
      p, m, cr = rtpost(gdf.newcases, γ, σ, x-&gt;pdf(truncated(Gamma(4,1),0,8), x),
                      (λ,x)-&gt;pdf(NegativeBinomial(λ*nbp/(1-nbp), nbp),x));
      f = plot(gdf.date, m, ribbon=(m-cr[:,1], cr[:,2] - m), title=unique(gdf.state)[1], legend=:none, ylabel=&quot;Rₜ&quot;)
      f = hline!(f,[1.0])
      figs = vcat(figs, f)
    end
    l = @layout [a{.1h};grid(1,1)]
    display(plot(plot(annotation=(0.5,0.5, &quot;Negative binomial, p=$nbp, &amp; σ=$σ&quot;), framestyle = :none),
                 plot(figs[1:9]..., layout=(3,3)), layout=l, reuse=false))
  end
end
</code></pre>

<pre><code>(t, cases[t], cases[t - 1]) = (78, 2807, 9)
(t, cases[t], cases[t - 1]) = (79, 1, 2807)
(t, cases[t], cases[t - 1]) = (80, 2808, 1)
(t, cases[t], cases[t - 1]) = (54, -39, 74)
(t, cases[t], cases[t - 1]) = (54, -39, 74)
(t, cases[t], cases[t - 1]) = (54, -39, 74)
(t, cases[t], cases[t - 1]) = (78, 2807, 9)
(t, cases[t], cases[t - 1]) = (79, 1, 2807)
(t, cases[t], cases[t - 1]) = (80, 2808, 1)
(t, cases[t], cases[t - 1]) = (54, -39, 74)
(t, cases[t], cases[t - 1]) = (54, -39, 74)
(t, cases[t], cases[t - 1]) = (54, -39, 74)
(t, cases[t], cases[t - 1]) = (78, 2807, 9)
(t, cases[t], cases[t - 1]) = (79, 1, 2807)
(t, cases[t], cases[t - 1]) = (80, 2808, 1)
(t, cases[t], cases[t - 1]) = (54, -39, 74)
(t, cases[t], cases[t - 1]) = (54, -39, 74)
(t, cases[t], cases[t - 1]) = (54, -39, 74)
</code></pre>
<p><img alt="" src="../figures/Rt_3_1.png" /> <img alt="" src="../figures/Rt_3_2.png" /> <img alt="" src="../figures/Rt_3_3.png" />
<img alt="" src="../figures/Rt_3_4.png" /> <img alt="" src="../figures/Rt_3_5.png" /> <img alt="" src="../figures/Rt_3_6.png" />
<img alt="" src="../figures/Rt_3_7.png" /> <img alt="" src="../figures/Rt_3_8.png" /> <img alt="" src="../figures/Rt_3_9.png" /></p>
<p>What Systrom did was smooth the new cases before using the Poisson
distribution. He used a window width of $7$ and Gaussian weights with
standard deviation $2$.</p>
<pre><code class="julia">using RollingFunctions
σ = 0.25
Plots.closeall()
for w in [3, 7, 11]
  for s in [0.5, 2, 4]
    γ =1/7
    nbp = 0.01
    figs = []
    for gdf in groupby(sdf, :state)
      windowsize = w
      weights = pdf(Normal(0, s), -floor(windowsize/2):floor(windowsize/2))
      weights = weights/sum(weights)
      smoothcases = Int.(round.(runmean(gdf.newcases[2:end], windowsize, weights*windowsize)))
      p, m, cr = rtpost(smoothcases, γ, σ, x-&gt;pdf(truncated(Gamma(4,1),0,8), x),
                        (λ,x)-&gt;pdf(Poisson(λ),x))
      f = plot(gdf.date, m, ribbon=(m-cr[:,1], cr[:,2] - m), title=unique(gdf.state)[1], legend=:none, ylabel=&quot;Rₜ&quot;)
      f = hline!(f,[1.0])
      figs = vcat(figs, f)
    end
    l = @layout [a{.1h};grid(1,1)]
    display(plot(plot(annotation=(0.5,0.5, &quot;Poisson &amp; σ=$σ, s=$s, w=$w&quot;), framestyle = :none),
                 plot(figs[1:9]..., layout=(3,3)), layout=l, reuse=false))
  end
end
</code></pre>

<pre><code>(t, cases[t], cases[t - 1]) = (54, -4, 68)
(t, cases[t], cases[t - 1]) = (56, -4, 68)
(t, cases[t], cases[t - 1]) = (58, -4, 68)
</code></pre>
<p><img alt="" src="../figures/Rt_4_1.png" /> <img alt="" src="../figures/Rt_4_2.png" /> <img alt="" src="../figures/Rt_4_3.png" />
<img alt="" src="../figures/Rt_4_4.png" /> <img alt="" src="../figures/Rt_4_5.png" /> <img alt="" src="../figures/Rt_4_6.png" />
<img alt="" src="../figures/Rt_4_7.png" /> <img alt="" src="../figures/Rt_4_8.png" /> <img alt="" src="../figures/Rt_4_9.png" /></p>
<p>Here we see that we can get a variety of results depending on the
smoothing used. All of these posteriors ignore the uncertainty in the
choice of smoothing parameters (and procedure).</p>
<h2 id="an-alternative-approach">An alternative approach<a class="headerlink" href="#an-alternative-approach" title="Permanent link">&para;</a></h2>
<p>Here we follow an approach similar in spirit to Systrom, with a few
additions. First, we utilize data on movement and business operations as
auxillary noisy measures of $R_t$. Second, we allow state policies to
shift the mean of $R_t$. Third, we combine data from all states to
improve precision in each. Fourth, we incorporate testing numbers into
the data.</p>
<p>As above, we assume that <script type="math/tex; mode=display">
k_{st} | R_{st}, k_{s,t-1}, ... \sim Poisson(k_{s,t-1} \frac{\tau_{s,t}}{\tau_{s,t-1}} e^{\gamma(R_{st} - 1)})
</script>
</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Any distribution with mean
$k_{t-1} \frac{\tau{t}}{\tau{t-1}} e^{\gamma(R_t - 1)}$ makes
sense here. What other choice could incorporate measurement
error so that cases don&rsquo;t need to be smoothed in advance?</p>
</div>
<p>We will allow state policies, $d_{s,t}$ to affect the mean of $R_t$.
Specifically, we’ll assume that</p>
<p>
<script type="math/tex; mode=display">
R_{st} | R_{s,t-1}, d_{st} \sim N(\alpha_r R_{t-1} +
d_{s,t} \alpha, \sigma^2)
</script>
</p>
<p>Measures of movement and business operations are used as noisy measures
of $R_{s,t}$</p>
<p>
<script type="math/tex; mode=display">
m_{s,t} ~ N(\lambda_r R_{s,t} + x_{st} \lambda, \Sigma_m)
</script>
</p>
<p>where $x_{st}$ could include e.g. state demographics and day of week
indicators.</p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Should $x_{st}$ include policies? I think yes.</p>
</div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>What to do about $\tau$? One idea is to assume
$\frac{\tau_{s,t}}{\tau_{s,t-1}}$ is a function of test
numbers. However, numbers of tests are likely responding to policies,
$d_{st}$ and cases $k_{st}$.</p>
</div>
<p>The parameters $\gamma$, $\alpha$, $\lambda$, $\sigma$, and $\Sigma_m$
are assumed to be common across states.</p>
<h1 id="code_1">Code<a class="headerlink" href="#code_1" title="Permanent link">&para;</a></h1>
<p>The model</p>
<pre><code class="julia">using Turing, CovidSEIR, Plots, PrettyTables, Dates
using LinearAlgebra: dot, diagm, Symmetric, I

@model rt(cases, m, d, x, ::Type{Rtype}=Float64) where {Rtype &lt;: Real} = begin
  # Priors
  γ ~ truncated(Normal(1/7, 1/2), 1/21, 1/3)
  σ ~ truncated(Normal(0.25,1), 1e-6, Inf)
  meanR0 ~ truncated(Normal(3, 2), 0, Inf)
  sigR0 ~ truncated(Normal(1,1), 1e-2, Inf)
  αR ~ truncated(Normal(0.5, 2), -0.9, 0.9)
  α ~ MvNormal(zeros(size(d, 1)), 1.0)
  λR ~ MvNormal(zeros(size(m, 1)), 1.0)
  λ ~ MvNormal(zeros(size(m,1)*size(x,1)), 1.0)
  λ = reshape(λ, size(m,1), size(x,1))
  J = size(m,1)
  #Cm ~ LKJ(J, 2.0)
  #m = diagm(ones(J))
  sm ~ MvNormal(zeros(J), 1)
  Σm = diagm(exp.(sm)) + I*1e-4
  #Σm = Cm.*(exp.(sm)*exp.(sm)')
  #Σm ~ Wishart(J+2, diagm(ones(J))*1/(2*0.001))
  if (cases === missing) # for simulating the model
    cases = Matrix{Rtype}(undef, T, S)
  end
  J, T, S = size(m)
  @assert (T,S) == size(cases)
  @assert size(x,2) == T &amp;&amp; size(d,2) == T
  @assert size(x,3) == S &amp;&amp; size(d,3) == S
  R = Matrix{Rtype}(undef, T, S)
  e = Matrix{Rtype}(undef, T, S)
  for s in 1:S
    R[1,s] = meanR0
    e[1,s] ~ Normal(0, sigR0)
    for t in 2:T
      e[t,s] ~ Normal(αR*e[t-1,s], σ)
      R[t,s] = e[t,s] + dot(α, d[:,t,s])
      #R[t,s] ~ truncated(Normal(αR*R[t-1,s] + dot(α,d[:,t,s]), σ), 0, 20)
      if (t&gt;2) # cases[1,s] is missing because cases is the diff of cumulative cases
        meank = max(cases[t-1, s], 1e-1)*exp(γ*(R[t,s]-1))
        #@show t, meank, cases[t-1,s], R[t,s], meanR0, sigR0, αR
        cases[t, s] ~ Poisson(meank)
        #cases[t,s] ~ truncated(Normal(meank, meank), 0, Inf)
      end
      if !any(ismissing.(m[:,t,s]))
        m[:,t,s] ~ MvNormal(λR*R[t,s] + λ*x[:,t,s],  Symmetric(Σm))
      end
    end
  end
  return(cases, R) # return only matters when simulating model
end
</code></pre>

<p>Prepare the data.</p>
<pre><code class="julia">df = CovidSEIR.statedata()
df = df[df[!,:fips].&lt;60,:] # get ride of non-states (AS, GU, etc)

df[!, :weekend] = 1*(Dates.dayofweek.(df[!,:date]) .&gt;= 6)
pvars = [Symbol(&quot;Stay.at.home..shelter.in.place&quot;),
         Symbol(&quot;State.of.emergency&quot;),
         Symbol(&quot;Date.closed.K.12.schools&quot;),
         #Symbol(&quot;Closed.day.cares&quot;),
         #Symbol(&quot;Date.banned.visitors.to.nursing.homes&quot;),
         Symbol(&quot;Closed.non.essential.businesses&quot;),
         Symbol(&quot;Closed.restaurants.except.take.out&quot;)]
dvars=  [:weekend]
mvars =  [:retail_and_recreation_percent_change_from_baseline,
          :grocery_and_pharmacy_percent_change_from_baseline,
          #:parks_percent_change_from_baseline,
          #:transit_stations_percent_change_from_baseline,
          #:workplaces_percent_change_from_baseline,
          #:residential_percent_change_from_baseline,
          #:percentchangehours,
          :percentchangebusinesses]
xvars = dvars

states = unique(df[!,:state])
dates = sort(unique(df[!,:date]))
S = length(states)
T = length(dates)
d = Array{Float64,3}(undef, length(dvars) + length(pvars), T, S)
x = Array{Float64,3}(undef, length(xvars) + length(pvars), T, S)
m = Array{Union{Missing,Float64},3}(missing, length(mvars), T, S)
cc = Matrix{Union{Missing,Float64}}(missing, T,S)
cases = Matrix{Union{Missing,Float64}}(missing, T,S)
for (s, st) in enumerate(states)
  for (t, dt) in enumerate(dates)
    inc = findall((df[!,:state] .== st) .&amp; (df[!,:date] .==dt))
    @assert length(inc)==1
    i = inc[1]
    p = convert(Array, df[i,pvars]) .&lt; dt
    p[ismissing.(p)] .= false
    d[:,t,s] .= vcat(p, convert(Array, df[i, dvars]))
    x[:,t,s] .= vcat(p, convert(Array, df[i, xvars]))
    m[:,t,s] .= convert(Array, df[i, mvars])./100
    cc[t,s] = df[i, :cases]
    if (t&gt;1)
      cases[t,s] = max(0.0,cc[t,s] - cc[t-1,s])
    end
  end
end
</code></pre>

<p>Estimation</p>
<pre><code class="julia">mdl = rt(cases, m, d, x)
#@time  chain=Turing.sample(mdl, HMC(1e-6, 3), 50);

#using Turing.Variational
#q0 = Variational.meanfield(mdl);
#advi = ADVI(10, 10_000)
#@time q = vi(mdl, ADVI(10,100), q0, optimizer=Variational.DecayedADAGrad(1e-2, 1.1, 0.9));
#chain = Turing.sample(mdl, NUTS(500, 0.65, max_depth=4, init_ϵ=1e-4), 1000)
</code></pre>

<div class="references hanging-indent" id="refs">
<div id="ref-bettencourt2008">
<p>Bettencourt, Ruy M., Luís M. A. AND Ribeiro. 2008. “Real Time Bayesian
Estimation of the Epidemic Potential of Emerging Infectious Diseases.”
<em>PLOS ONE</em> 3 (5): 1–9. <a href="https://doi.org/10.1371/journal.pone.0002185">https://doi.org/10.1371/journal.pone.0002185</a>.</p>
</div>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Paul Schrimpf</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML" defer></script>
        <script src="../assets/mathjaxhelper.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
